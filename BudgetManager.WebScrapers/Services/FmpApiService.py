import requests
from Models.CompanyProfile import CompanyProfile
from typing import List
from Models.Fmp.Dividends import Dividends
from Models.Fmp.SectorsPerformanceModel import SectorsPerformanceModel


class FmpApiService:
    token: str
    exchanges: List[str] = ["NYSE", "NASDAQ", "AMEX", "EURONEXT"]
    fmpUri: str = "https://financialmodelingprep.com"

    def __init__(self, apiToken: str):
        self.token = apiToken

    def get_company_profile(self, ticker: str):
        response = requests.get(f'{self.fmpUri}/api/v3/profile/{ticker}?apikey={self.token}')
        jsonData = response.json()
        jsonObj = jsonData[0]
        return CompanyProfile.create_from_json(jsonObj)

    def get_historical_dividend(self, ticker: str):
        response = requests.get(
            f'{self.fmpUri}/api/v3/historical-price-full/stock_dividend/{ticker}?apikey={self.token}')
        jsonData = response.json()
        # jsonData = {'symbol': 'AAPL', 'historical': [{'date': '2022-02-04', 'label': 'February 04, 22', 'adjDividend': 0.22, 'dividend': 0.22, 'recordDate': '2022-02-07', 'paymentDate': '2022-02-10', 'declarationDate': '2022-01-27'}, {'date': '2021-11-05', 'label': 'November 05, 21', 'adjDividend': 0.22, 'dividend': 0.22, 'recordDate': '2021-11-08', 'paymentDate': '2021-11-11', 'declarationDate': '2021-10-28'}, {'date': '2021-08-06', 'label': 'August 06, 21', 'adjDividend': 0.22, 'dividend': 0.22, 'recordDate': '2021-08-09', 'paymentDate': '2021-08-12', 'declarationDate': '2021-07-27'}, {'date': '2021-05-07', 'label': 'May 07, 21', 'adjDividend': 0.22, 'dividend': 0.22, 'recordDate': '2021-05-10', 'paymentDate': '2021-05-13', 'declarationDate': '2021-04-28'}, {'date': '2021-02-05', 'label': 'February 05, 21', 'adjDividend': 0.205, 'dividend': 0.205, 'recordDate': '2021-02-08', 'paymentDate': '2021-02-11', 'declarationDate': '2021-01-27'}, {'date': '2020-11-06', 'label': 'November 06, 20', 'adjDividend': 0.205, 'dividend': 0.205, 'recordDate': '2020-11-09', 'paymentDate': '2020-11-12', 'declarationDate': '2020-10-29'}, {'date': '2020-08-07', 'label': 'August 07, 20', 'adjDividend': 0.205, 'dividend': 0.82, 'recordDate': '2020-08-10', 'paymentDate': '2020-08-13', 'declarationDate': '2020-07-30'}, {'date': '2020-05-08', 'label': 'May 08, 20', 'adjDividend': 0.205, 'dividend': 0.82, 'recordDate': '2020-05-11', 'paymentDate': '2020-05-14', 'declarationDate': '2020-04-30'}, {'date': '2020-02-07', 'label': 'February 07, 20', 'adjDividend': 0.1925, 'dividend': 0.77, 'recordDate': '2020-02-10', 'paymentDate': '2020-02-13', 'declarationDate': '2020-01-28'}, {'date': '2019-11-07', 'label': 'November 07, 19', 'adjDividend': 0.1925, 'dividend': 0.77, 'recordDate': '2019-11-11', 'paymentDate': '2019-11-14', 'declarationDate': '2019-10-30'}, {'date': '2019-08-09', 'label': 'August 09, 19', 'adjDividend': 0.1925, 'dividend': 0.77, 'recordDate': '2019-08-12', 'paymentDate': '2019-08-15', 'declarationDate': '2019-07-30'}, {'date': '2019-05-10', 'label': 'May 10, 19', 'adjDividend': 0.1925, 'dividend': 0.77, 'recordDate': '2019-05-13', 'paymentDate': '2019-05-16', 'declarationDate': '2019-05-01'}, {'date': '2019-02-08', 'label': 'February 08, 19', 'adjDividend': 0.1825, 'dividend': 0.73, 'recordDate': '2019-02-11', 'paymentDate': '2019-02-14', 'declarationDate': '2019-01-29'}, {'date': '2018-11-08', 'label': 'November 08, 18', 'adjDividend': 0.1825, 'dividend': 0.73, 'recordDate': '2018-11-12', 'paymentDate': '2018-11-15', 'declarationDate': '2018-11-01'}, {'date': '2018-08-10', 'label': 'August 10, 18', 'adjDividend': 0.1825, 'dividend': 0.73, 'recordDate': '2018-08-13', 'paymentDate': '2018-08-16', 'declarationDate': '2018-07-31'}, {'date': '2018-05-11', 'label': 'May 11, 18', 'adjDividend': 0.1825, 'dividend': 0.73, 'recordDate': '2018-05-14', 'paymentDate': '2018-05-17', 'declarationDate': '2018-05-01'}, {'date': '2018-02-09', 'label': 'February 09, 18', 'adjDividend': 0.1575, 'dividend': 0.63, 'recordDate': '2018-02-12', 'paymentDate': '2018-02-15', 'declarationDate': '2018-02-01'}, {'date': '2017-11-10', 'label': 'November 10, 17', 'adjDividend': 0.1575, 'dividend': 0.63, 'recordDate': '2017-11-13', 'paymentDate': '2017-11-16', 'declarationDate': '2017-11-02'}, {'date': '2017-08-10', 'label': 'August 10, 17', 'adjDividend': 0.1575, 'dividend': 0.63, 'recordDate': '2017-08-14', 'paymentDate': '2017-08-17', 'declarationDate': '2017-08-01'}, {'date': '2017-05-11', 'label': 'May 11, 17', 'adjDividend': 0.1575, 'dividend': 0.63, 'recordDate': '2017-05-15', 'paymentDate': '2017-05-18', 'declarationDate': '2017-05-02'}, {'date': '2017-02-09', 'label': 'February 09, 17', 'adjDividend': 0.1425, 'dividend': 0.57, 'recordDate': '2017-02-13', 'paymentDate': '2017-02-16', 'declarationDate': '2017-02-01'}, {'date': '2016-11-03', 'label': 'November 03, 16', 'adjDividend': 0.1425, 'dividend': 0.57, 'recordDate': '2016-11-07', 'paymentDate': '2016-11-10', 'declarationDate': '2016-10-25'}, {'date': '2016-08-04', 'label': 'August 04, 16', 'adjDividend': 0.1425, 'dividend': 0.57, 'recordDate': '2016-08-08', 'paymentDate': '2016-08-11', 'declarationDate': '2016-07-26'}, {'date': '2016-05-05', 'label': 'May 05, 16', 'adjDividend': 0.1425, 'dividend': 0.57, 'recordDate': '2016-05-09', 'paymentDate': '2016-05-12', 'declarationDate': '2016-04-26'}, {'date': '2016-02-04', 'label': 'February 04, 16', 'adjDividend': 0.13, 'dividend': 0.52, 'recordDate': '2016-02-08', 'paymentDate': '2016-02-11', 'declarationDate': '2016-01-26'}, {'date': '2015-11-05', 'label': 'November 05, 15', 'adjDividend': 0.13, 'dividend': 0.52, 'recordDate': '2015-11-09', 'paymentDate': '2015-11-12', 'declarationDate': '2015-10-27'}, {'date': '2015-08-06', 'label': 'August 06, 15', 'adjDividend': 0.13, 'dividend': 0.52, 'recordDate': '2015-08-10', 'paymentDate': '2015-08-13', 'declarationDate': '2015-07-21'}, {'date': '2015-05-07', 'label': 'May 07, 15', 'adjDividend': 0.13, 'dividend': 0.52, 'recordDate': '2015-05-11', 'paymentDate': '2015-05-14', 'declarationDate': '2015-04-27'}, {'date': '2015-02-05', 'label': 'February 05, 15', 'adjDividend': 0.1175, 'dividend': 0.47, 'recordDate': '2015-02-09', 'paymentDate': '2015-02-12', 'declarationDate': '2015-01-27'}, {'date': '2014-11-06', 'label': 'November 06, 14', 'adjDividend': 0.1175, 'dividend': 0.47, 'recordDate': '2014-11-10', 'paymentDate': '2014-11-13', 'declarationDate': '2014-10-20'}, {'date': '2014-08-07', 'label': 'August 07, 14', 'adjDividend': 0.1175, 'dividend': 0.47, 'recordDate': '2014-08-11', 'paymentDate': '2014-08-14', 'declarationDate': '2014-07-22'}, {'date': '2014-05-08', 'label': 'May 08, 14', 'adjDividend': 0.1175, 'dividend': 3.29, 'recordDate': '2014-05-12', 'paymentDate': '2014-05-15', 'declarationDate': '2014-04-23'}, {'date': '2014-02-06', 'label': 'February 06, 14', 'adjDividend': 0.108929, 'dividend': 3.05, 'recordDate': '2014-02-10', 'paymentDate': '2014-02-13', 'declarationDate': '2014-01-27'}, {'date': '2013-11-06', 'label': 'November 06, 13', 'adjDividend': 0.108929, 'dividend': 3.05, 'recordDate': '2013-11-11', 'paymentDate': '2013-11-14', 'declarationDate': '2013-10-28'}, {'date': '2013-08-08', 'label': 'August 08, 13', 'adjDividend': 0.108929, 'dividend': 3.05, 'recordDate': '2013-08-12', 'paymentDate': '2013-08-15', 'declarationDate': '2013-07-23'}, {'date': '2013-05-09', 'label': 'May 09, 13', 'adjDividend': 0.108929, 'dividend': 3.05, 'recordDate': '2013-05-13', 'paymentDate': '2013-05-16', 'declarationDate': '2013-04-23'}, {'date': '2013-02-07', 'label': 'February 07, 13', 'adjDividend': 0.094643, 'dividend': 2.65, 'recordDate': '2013-02-11', 'paymentDate': '2013-02-14', 'declarationDate': '2013-01-23'}, {'date': '2012-11-07', 'label': 'November 07, 12', 'adjDividend': 0.094643, 'dividend': 2.65, 'recordDate': '2012-11-12', 'paymentDate': '2012-11-15', 'declarationDate': '2012-10-25'}, {'date': '2012-08-09', 'label': 'August 09, 12', 'adjDividend': 0.094643, 'dividend': 2.65, 'recordDate': '2012-08-13', 'paymentDate': '2012-08-16', 'declarationDate': '2012-03-19'}, {'date': '1995-11-21', 'label': 'November 21, 95', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1995-11-20', 'label': 'November 20, 95', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1995-11-24', 'paymentDate': '1995-12-15', 'declarationDate': '1995-10-09'}, {'date': '1995-08-16', 'label': 'August 16, 95', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '1995-08-18', 'paymentDate': '1995-09-08', 'declarationDate': '1995-07-20'}, {'date': '1995-05-29', 'label': 'May 29, 95', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1995-06-02', 'paymentDate': '1995-06-23', 'declarationDate': '1995-05-02'}, {'date': '1995-05-26', 'label': 'May 26, 95', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1995-02-14', 'label': 'February 14, 95', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1995-02-17', 'paymentDate': '1995-03-10', 'declarationDate': ''}, {'date': '1995-02-13', 'label': 'February 13, 95', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1994-11-21', 'label': 'November 21, 94', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1994-11-25', 'paymentDate': '1994-12-16', 'declarationDate': ''}, {'date': '1994-11-18', 'label': 'November 18, 94', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1994-08-16', 'label': 'August 16, 94', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1994-08-19', 'paymentDate': '1994-09-09', 'declarationDate': ''}, {'date': '1994-08-15', 'label': 'August 15, 94', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1994-05-30', 'label': 'May 30, 94', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1994-06-03', 'paymentDate': '1994-06-24', 'declarationDate': ''}, {'date': '1994-05-27', 'label': 'May 27, 94', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1994-02-08', 'label': 'February 08, 94', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1994-02-11', 'paymentDate': '1994-03-04', 'declarationDate': '1994-02-02'}, {'date': '1994-02-07', 'label': 'February 07, 94', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1993-11-22', 'label': 'November 22, 93', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1993-11-26', 'paymentDate': '1993-12-17', 'declarationDate': ''}, {'date': '1993-11-19', 'label': 'November 19, 93', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1993-08-17', 'label': 'August 17, 93', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1993-08-20', 'paymentDate': '1993-09-10', 'declarationDate': ''}, {'date': '1993-08-16', 'label': 'August 16, 93', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1993-06-01', 'label': 'June 01, 93', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1993-06-04', 'paymentDate': '1993-06-25', 'declarationDate': ''}, {'date': '1993-05-28', 'label': 'May 28, 93', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1993-02-16', 'label': 'February 16, 93', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1993-02-19', 'paymentDate': '1993-03-12', 'declarationDate': ''}, {'date': '1993-02-12', 'label': 'February 12, 93', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1992-11-30', 'label': 'November 30, 92', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '1992-12-04', 'paymentDate': '1992-12-18', 'declarationDate': '1992-11-23'}, {'date': '1992-08-17', 'label': 'August 17, 92', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '1992-08-21', 'paymentDate': '1992-09-11', 'declarationDate': ''}, {'date': '1992-06-01', 'label': 'June 01, 92', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1992-02-14', 'label': 'February 14, 92', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '1992-02-21', 'paymentDate': '1992-03-13', 'declarationDate': ''}, {'date': '1991-11-18', 'label': 'November 18, 91', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '1991-11-22', 'paymentDate': '1991-12-13', 'declarationDate': ''}, {'date': '1991-08-19', 'label': 'August 19, 91', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '1991-08-23', 'paymentDate': '1991-09-13', 'declarationDate': ''}, {'date': '1991-05-20', 'label': 'May 20, 91', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '1991-05-24', 'paymentDate': '1991-06-14', 'declarationDate': ''}, {'date': '1991-02-19', 'label': 'February 19, 91', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1991-02-22', 'paymentDate': '1991-03-15', 'declarationDate': ''}, {'date': '1991-02-15', 'label': 'February 15, 91', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1990-11-19', 'label': 'November 19, 90', 'adjDividend': 0.0010714275, 'dividend': 0.12, 'recordDate': '1990-11-23', 'paymentDate': '1990-12-14', 'declarationDate': '1990-11-08'}, {'date': '1990-11-16', 'label': 'November 16, 90', 'adjDividend': 0.001071, 'dividend': 0.12, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1990-08-21', 'label': 'August 21, 90', 'adjDividend': 0.0009821419, 'dividend': 0.11, 'recordDate': '1990-08-24', 'paymentDate': '1990-09-14', 'declarationDate': '1990-07-23'}, {'date': '1990-08-20', 'label': 'August 20, 90', 'adjDividend': 0.000982, 'dividend': 0.11, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1990-05-22', 'label': 'May 22, 90', 'adjDividend': 0.0009821419, 'dividend': 0.11, 'recordDate': '1990-05-25', 'paymentDate': '1990-06-15', 'declarationDate': '1990-04-09'}, {'date': '1990-05-21', 'label': 'May 21, 90', 'adjDividend': 0.000982, 'dividend': 0.11, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1990-02-19', 'label': 'February 19, 90', 'adjDividend': 0.0009821419, 'dividend': 0.11, 'recordDate': '1990-02-23', 'paymentDate': '1990-03-15', 'declarationDate': '1990-02-02'}, {'date': '1990-02-16', 'label': 'February 16, 90', 'adjDividend': 0.000982, 'dividend': 0.11, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1989-11-17', 'label': 'November 17, 89', 'adjDividend': 0.000982, 'dividend': 0.1, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1989-08-21', 'label': 'August 21, 89', 'adjDividend': 0.000893, 'dividend': 0.1, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1989-05-22', 'label': 'May 22, 89', 'adjDividend': 0.000893, 'dividend': 0.1, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1989-02-17', 'label': 'February 17, 89', 'adjDividend': 0.000893, 'dividend': 0.1, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1988-11-21', 'label': 'November 21, 88', 'adjDividend': 0.000893, 'dividend': 0.1, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1988-08-15', 'label': 'August 15, 88', 'adjDividend': 0.000714, 'dividend': 0.08, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1988-05-16', 'label': 'May 16, 88', 'adjDividend': 0.000714, 'dividend': 0.08, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1988-02-12', 'label': 'February 12, 88', 'adjDividend': 0.000714, 'dividend': 0.08, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1987-11-17', 'label': 'November 17, 87', 'adjDividend': 0.000714, 'dividend': 0.08, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1987-08-10', 'label': 'August 10, 87', 'adjDividend': 0.000536, 'dividend': 0.06, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}, {'date': '1987-05-11', 'label': 'May 11, 87', 'adjDividend': 0.000536, 'dividend': 0.06, 'recordDate': '', 'paymentDate': '', 'declarationDate': ''}]}
        return Dividends.create_from_json(jsonData)

    def get_sector_performance(self):
        response = requests.get(f'{self.fmpUri}/api/v3/sectors-performance?apikey={self.token}')
        jsonData = response.json()
        # jsonData = [{"sector":"BasicMaterials","changesPercentage":"0.9725%"},{"sector":"CommunicationServices","changesPercentage":"0.8804%"},{"sector":"ConsumerCyclical","changesPercentage":"0.5338%"},{"sector":"ConsumerDefensive","changesPercentage":"0.9416%"},{"sector":"Energy","changesPercentage":"1.6889%"},{"sector":"FinancialServices","changesPercentage":"0.3667%"},{"sector":"Healthcare","changesPercentage":"0.6816%"},{"sector":"Industrials","changesPercentage":"0.6143%"},{"sector":"RealEstate","changesPercentage":"0.3742%"},{"sector":"Technology","changesPercentage":"0.7689%"},{"sector":"Utilities","changesPercentage":"0.3905%"}]
        models = []

        for sector_data in jsonData:
            sector_model = SectorsPerformanceModel.create_from_json(sector_data)
            models.append(sector_model)

        return models

    def get_stock_news(self, tickers: List[str], limit: int = 100):
        joinedTicker = str.join(tickers)
        response = requests.get(f'{self.fmpUri}/api/v3/stock_news?tickers={joinedTicker}&limit={limit}')
        print(response.json())

    def get_stock_news(self, limit: int = 100):
        response = requests.get(f'{self.fmpUri}/api/v3/stock_news?limit={limit}')
        print(response.json())

    # DONT HAVE PERMISION TO THIS ENDPOINT
    # def get_sector_pe(self, date: datetime):
    #     response = requests.get(f'{self.fmpUri}/api/v4/sector_price_earning_ratio?date={date.strftime("%m-%d-%Y")}&exchange=NYSE&apikey={self.token}')
    #     jsonData = response.json()
    #     models = []
    #
    #     for sectorPe in jsonData:
    #         models.append(SectorPeModel.create_from_json(sectorPe))
