DECLARE @FromDate DATE = '2022-01-01';  -- Replace with your actual from date
DECLARE @ToDate DATE = '2023-12-31';    -- Replace with your actual to date

;WITH AggregatedTrades AS (
    SELECT
        cth.CryptoTickerId,
        cth.TradeTimeStamp,
        SUM(CASE WHEN cth.TradeValue >= 0 THEN -cth.TradeSize ELSE cth.TradeSize END) AS TotalTradeSize,
        SUM(cth.TradeValue) AS TotalTradeValue,
        SUM(SUM(CASE WHEN cth.TradeValue >= 0 THEN -cth.TradeSize ELSE cth.TradeSize END)) OVER (PARTITION BY cth.CryptoTickerId ORDER BY cth.TradeTimeStamp) AS AccumulatedTradeSize
    FROM
        [dbo].[CryptoTradeHistory] cth
    WHERE
        cth.TradeTimeStamp BETWEEN @FromDate AND @ToDate
    GROUP BY
        cth.CryptoTickerId,
        cth.TradeTimeStamp
)
SELECT
    CryptoTickerId,
    TradeTimeStamp,
    TotalTradeSize,
    TotalTradeValue,
    AccumulatedTradeSize
FROM
    AggregatedTrades
ORDER BY
    CryptoTickerId, TradeTimeStamp;
